USE DATERODB;

--------------------------------------------------------
-- Insercion de datos en procedimientos alamcenados --
--------------------------------------------------------
-- RUTAS --
DELIMITER //
CREATE PROCEDURE AGREGAR_RUTAS
(IN EST BOOLEAN, IN NOM VARCHAR(30))
BEGIN
	INSERT INTO RUTAS (EST_RUTA, NOM_RUTA) 
    VALUES(EST, NOM);
END //

-- DISTRITOS --
DELIMITER //
CREATE PROCEDURE AGREGAR_DISTRITOS
(IN EST BOOLEAN, IN NOM VARCHAR(30))
BEGIN
 INSERT INTO DISTRITOS(EST_DIS, NOM_DIS)
 VALUES(EST, NOM);
END //

-- PARADEROS --
DELIMITER //
CREATE PROCEDURE AGREGAR_PARADEROS
(IN EST BOOLEAN, IN NOM VARCHAR(30), IN DIS INT)
BEGIN
	INSERT INTO PARADEROS(EST_PAR, NOM_PAR, DIS_ID) 
    VALUES (EST, NOM, DIS);
END //

-- RP --
DELIMITER //
CREATE PROCEDURE AGREGAR_RP
(IN EST BOOLEAN, IN ORDEN INT, IN PARADERO INT , IN RUTA INT)
BEGIN 
	INSERT INTO RP(EST_RP, ORDEN_RP, PAR_ID, RUTA_ID)
    VALUES(EST, ORDEN, PARADERO, RUTA);
END //

-- ROLES --
DELIMITER //
CREATE PROCEDURE AGREGAR_ROLES
(IN EST BOOLEAN, IN NOM VARCHAR(30))
BEGIN
	INSERT  INTO ROLES(EST_ROL, NOM_ROL)
    VALUES(EST, NOM);
END //

-- USUARIOS --
DELIMITER // 
CREATE PROCEDURE AGREGAR_USUARIO
(IN EST BOOLEAN, IN  NOMU VARCHAR(30), IN PASS VARCHAR(30), IN ROL INT)
BEGIN
	INSERT INTO USUARIOS(EST_USU, USER_USU, PASS_USU, ROL_ID)
    VALUES(EST, NOMU, PASS, ROL);
END //

-- EMPRESAS --
DELIMITER //
CREATE PROCEDURE AGREGAR_EMPRESAS
(IN EST BOOLEAN, IN NOM VARCHAR(30))
BEGIN
	INSERT INTO EMPRESAS(EST_EMP, NOM_EMP)
    VALUES(EST, NOM);
END //

-- TRABAJADORES --
DELIMITER //
CREATE PROCEDURE AGREGAR_TRABAJADORES
(IN NOM VARCHAR(30), IN APE VARCHAR(30), IN DNI VARCHAR(30), IN EST BOOLEAN ,IN USUARIO INT, IN EMPRESA INT)
BEGIN
	INSERT INTO TRABAJADORES(NOM_TRA, APE_TRA, DNI_TRA, EST_TRA, USUARIO_ID, EMPRESA_ID)
    VALUES(NOM, APE, DNI,EST, USUARIO, EMPRESA);
END //

-- BUSES --
DELIMITER //
CREATE PROCEDURE AGREGAR_BUSES
(IN EST BOOLEAN, IN MODELO VARCHAR(30), IN PLACA VARCHAR(30), IN EMPRESA INT, IN RUTA INT, IN TRABAJADOR INT, IN RP INT)
BEGIN
	INSERT INTO BUSES(EST_BUS, MOD_BUS, PLACA_BUS, EMP_ID, RUTA_ID, TRABAJADOR_ID, RP_ID)
    VALUES(EST, MODELO, PLACA, EMPRESA, TRABAJADOR, RUTA, RP);
END //


DELIMITER //
CREATE PROCEDURE LISTAR_PARADEROS_DE_RUTA_IDA(IN RUTA INT)
BEGIN
	SELECT RP.ORDEN_RP, R.NOM_RUTA, P.NOM_PAR, D.NOM_DIS
	FROM RP 
	INNER JOIN RUTAS R ON RP.RUTA_ID = R.ID_RUTA
	INNER JOIN PARADEROS P ON RP.PAR_ID = P.ID_PAR
	INNER JOIN DISTRITOS D ON P.DIS_ID = D.ID_DIS
	WHERE R.ID_RUTA = RUTA
	ORDER BY RP.ORDEN_RP ASC;
END //


DELIMITER //
CREATE PROCEDURE LISTAR_PARADEROS_DE_RUTA_VUELTA(IN RUTA INT)
BEGIN
	SELECT RP.ORDEN_RP, R.NOM_RUTA, P.NOM_PAR, D.NOM_DIS
	FROM RP 
	INNER JOIN RUTAS R ON RP.RUTA_ID = R.ID_RUTA
	INNER JOIN PARADEROS P ON RP.PAR_ID = P.ID_PAR
	INNER JOIN DISTRITOS D ON P.DIS_ID = D.ID_DIS
	WHERE R.ID_RUTA = RUTA
	ORDER BY RP.ORDEN_RP DESC;
END //

DELIMITER //
CREATE PROCEDURE EMPEST
(IN ESTADO BOOLEAN)
BEGIN
	SELECT * FROM EMPRESAS 
	WHERE EST_EMP = ESTADO;
END //
--------------------------------------------------------
-- Creacion de vistas --
--------------------------------------------------------
CREATE VIEW LISTBUSESD
AS
SELECT B.ID_BUS, R.NOM_RUTA, B.PLACA_BUS, B.MOD_BUS, T.NOM_TRA, T.APE_TRA, E.NOM_EMP
FROM BUSES B
INNER JOIN TRABAJADORES T ON B.TRABAJADOR_ID = T.ID_TRA
INNER JOIN EMPRESAS E ON B.EMP_ID = E.ID_EMP
INNER JOIN RUTAS R ON B.RUTA_ID = R.ID_RUTA
ORDER BY B.ID_BUS ASC;

CREATE VIEW EMPRESAS_HABILITADAS
AS
SELECT * FROM EMPRESAS 
WHERE EST_EMP = 1;

CREATE VIEW EMPRESAS_DESHABILITADAS
AS
SELECT * FROM EMPRESAS 
WHERE EST_EMP = 0;

--------------------------------------------------------
-- CONSULTAS AVANZADAS --
--------------------------------------------------------
--------------------------------------------------------
-- Insercion de datos en procedimientos alamcenados --
--------------------------------------------------------
-- RUTAS --
CALL AGREGAR_RUTAS(1,'A023');
CALL AGREGAR_RUTAS(1,'B054');
CALL AGREGAR_RUTAS(1,'C323');
CALL AGREGAR_RUTAS(1,'C32D');
CALL AGREGAR_RUTAS(1,'D32T');
CALL AGREGAR_RUTAS(1,'D354');

-- DISTRITOS --

CALL AGREGAR_DISTRITOS(1,'SANTA ANITA');
CALL AGREGAR_DISTRITOS(1,'ATE');
CALL AGREGAR_DISTRITOS(1,'EL AGUSTINO');
CALL AGREGAR_DISTRITOS(1,'LA VICTORIA');
CALL AGREGAR_DISTRITOS(1,'CERCADO DE LIMA');
CALL AGREGAR_DISTRITOS(1,'CALLAO');
CALL AGREGAR_DISTRITOS(1,'HUAYCAN');
CALL AGREGAR_DISTRITOS(1,'SAN JUAN DE LURIGANCHO');
CALL AGREGAR_DISTRITOS(1,'RIMAC');
CALL AGREGAR_DISTRITOS(1,'SAN MIGUEL');


-- PARADEROS --
CALL AGREGAR_PARADEROS(1,'Puente Santa Anita',1);
CALL AGREGAR_PARADEROS(1,'Perales',1);
CALL AGREGAR_PARADEROS(1,'Ovalo Santa Anita',1);
CALL AGREGAR_PARADEROS(1,'Mall de Santa Anita',1);
CALL AGREGAR_PARADEROS(1,'Andahuaylas',1);

-- RP --

CALL AGREGAR_RP(1, 1, 1, 1);
CALL AGREGAR_RP(1, 2, 4, 1);
CALL AGREGAR_RP(1, 3, 2, 1);
CALL AGREGAR_RP(1, 1, 1, 2);
CALL AGREGAR_RP(1, 2, 4, 2);
CALL AGREGAR_RP(1, 3, 3, 2);

-- ROLES --
CALL AGREGAR_ROLES(1,'ADMINISTRADOR');
CALL AGREGAR_ROLES(1,'CONDUCTOR');

-- USUARIOS --
CALL AGREGAR_USUARIO(1,'ADMIN','2121',1);
CALL AGREGAR_USUARIO(1,'RAULY2','E12FD',2);
CALL AGREGAR_USUARIO(1,'MAUIRO','2015DOS',2);

-- EMPRESAS --
CALL AGREGAR_EMPRESAS(1,'SurfaceItn');
CALL AGREGAR_EMPRESAS(1,'IMPORTPERIO');

-- TRABAJADORES --
CALL AGREGAR_TRABAJADORES('JUAN', 'TORRES', '78547689', 1, 1, 1);

-- BUSES --

CALL AGREGAR_BUSES(1,'NISSAN', 'ABC-001', 1, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'ABC-1D5', 1, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'ABC-105', 1, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'ABC-145', 1, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'ABC-265', 1, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'ABC-13L', 1, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'ABC-523', 1, 1, 1, 1);

CALL AGREGAR_BUSES(1,'MERCEDES', 'A2C-105', 2, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'A2C-145', 2, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'A2C-265', 2, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'A3C-13L', 2, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'A4C-523', 2, 1, 1, 1);

CALL AGREGAR_BUSES(1,'MERCEDES', 'B2C-105', 12, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'B2C-145', 12, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'B2C-265', 12, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'B3C-13L', 12, 1, 1, 1);
CALL AGREGAR_BUSES(1,'MERCEDES', 'B4C-523', 12, 1, 1, 1);

CALL EMPEST(1);
--------------------------------------------------------
-- CONSULTAS AVANZADAS --
--------------------------------------------------------
SELECT * FROM RUTAS;
SELECT * FROM DISTRITOS;
SELECT * FROM PARADEROS;
SELECT * FROM RP;
SELECT * FROM ROLES;
SELECT * FROM USUARIOS;
SELECT * FROM EMPRESAS;
SELECT * FROM TRABAJADORES;
SELECT * FROM BUSES;

CALL LISTAR_PARADEROS_DE_RUTA_IDA(1);
CALL LISTAR_PARADEROS_DE_RUTA_VUELTA(1);

SELECT R.NOM_RUTA, PLACA_BUS, T.NOM_TRA, T.APE_TRA, E.NOM_EMP
FROM BUSES B
INNER JOIN TRABAJADORES T ON B.TRABAJADOR_ID = T.ID_TRA
INNER JOIN EMPRESAS E ON B.EMP_ID = E.ID_EMP
INNER JOIN RUTAS R ON B.RUTA_ID = R.ID_RUTA;

SELECT B.ID_BUS, R.NOM_RUTA, B.PLACA_BUS, B.MOD_BUS, T.NOM_TRA, T.APE_TRA
FROM BUSES B 
INNER JOIN RUTAS R ON B.RUTA_ID = R.ID_RUTA
INNER JOIN TRABAJADORES T ON B.TRABAJADOR_ID = T.ID_TRA
WHERE B.EMP_ID = 2;

DROP PROCEDURE BUSESXEMP;

DELIMITER //
CREATE PROCEDURE BUSESXEMP
(IN EMPRESA BIGINT)
BEGIN
	SELECT B.ID_BUS, R.NOM_RUTA, B.PLACA_BUS, B.MOD_BUS, T.NOM_TRA, T.APE_TRA, B.EST_BUS , E.NOM_EMP 
	FROM BUSES B 
	INNER JOIN RUTAS R ON B.RUTA_ID = R.ID_RUTA
	INNER JOIN TRABAJADORES T ON B.TRABAJADOR_ID = T.ID_TRA
    INNER JOIN EMPRESAS E ON E.ID_EMP = B.EMP_ID
	WHERE B.EMP_ID = EMPRESA;
END //

CALL BUSESXEMP(1); 

DELIMITER //
CREATE PROCEDURE BUSESXEMP2
(IN EMPRESA BIGINT)
BEGIN
	SELECT B.ID_BUS, B.PLACA_BUS, B.MOD_BUS, B.EST_BUS
	FROM BUSES B 
	INNER JOIN RUTAS R ON B.RUTA_ID = R.ID_RUTA
	INNER JOIN TRABAJADORES T ON B.TRABAJADOR_ID = T.ID_TRA
	WHERE B.EMP_ID = EMPRESA;
END //

CALL BUSESXEMP2(2); 


SELECT * FROM LISTBUSESD;

SELECT * FROM BUSES;



SELECT * FROM RTIEMPO;

SELECT B.PLACA_BUS, R.NOM_RUTA
FROM RTIEMPO RT 
INNER JOIN BUSES B ON RT.ID_RT = B.ID_BUS
INNER JOIN RUTAS R ON RT.RUTA_ID = R.ID_RUTA
INNER JOIN RP ON RT.RP_ID = RP.ID_RP
WHERE RT.RUTA_ID = 1; 

SELECT B.PLACA_BUS, R.NOM_RUTA, P.NOM_PAR, RT.TIEMPO
FROM RTIEMPO RT 
INNER JOIN BUSES B ON RT.BUS_ID = B.ID_BUS
INNER JOIN RP ON RT.RP_ID = RP.ID_RP
INNER JOIN RUTAS R ON R.ID_RUTA = RP.RUTA_ID
INNER JOIN PARADEROS P ON P.ID_PAR = RP.PAR_ID;

select * from EMPRESAS_HABILITADAS;



